#!/usr/bin/env python







def ConfigureMaraBuild():

    from os import getcwd, mkdir, system
    from shutil import copy
    from os.path import isfile, isdir
    from conf.templates import ConfigHeader, SystemMakefile

    if not isfile("conf/settings.lua"):
        copy("conf/default_settings.py", "conf/settings.py")

    from conf.settings import SystemConfig


    opts = { }
    opts.update(SystemConfig)

    extra = { 'hdf5libs': '-lz -lhdf5',
              'fftwlibs': '-lfftw',
              'glfwlibs': '',
              }

    extra['use_hdf5']     = isfile("%s/include/hdf5.h" % opts["hdf5"])
    extra['use_hdf5_par'] = isfile("%s/bin/h5pcc" % opts["hdf5"])
    extra['use_fftw']     = isfile("%s/include/fftw.h" % opts["fftw"])
    extra['use_glfw']     = opts["gl"]

    if not extra['use_hdf5'] : extra['hdf5libs'] = ""
    if not extra['use_fftw'] : extra['fftwlibs'] = ""
    if not extra['use_glfw'] : extra['glfwlibs'] = ""

    opts["install_dir"] = getcwd()
    SystemConfig.update(opts)


    print "\nConfiguring Mara with the following options:\n"
    print "\n".join(sorted(["%-16s = %s" % (a,b) for a,b in SystemConfig.items()]))+"\n"



    SysMakefile = open("conf/mara.conf", "w")
    SysMakefile.write(SystemMakefile % dict(SystemConfig.items() + extra.items()))

    CfgHeader = open("src/config.h", "w")
    CfgHeader.write(ConfigHeader % dict(SystemConfig.items() + extra.items()))

    if not isfile("conf/host.lua"):
        copy("conf/host.default.lua", "conf/host.lua")

    if not isdir("lib") or not isdir("bin") or not isdir("include"):
        cmd = "conf/setup true true %s %s" % ("true" if opts["gl"] else "false", opts["cc"])
        system(cmd)



if __name__ == "__main__":
    ConfigureMaraBuild()
